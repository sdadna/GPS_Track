<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=49GGbQCNje057FGWVlchcHeNNuAZKgMh"></script>
    <title>trace gps</title>
</head>

<body>  
	<div id="allmap"></div> 

</body>  
</html>
<script > 
	// 实时轨迹demo。
	// 实际运用的话可能ajax实时读取后台数据，加载到地图上。

	function loadData(){
	var xmlhttp;
	if(window.XMLHttpRequest){
		xmlhttp = new XMLHttpRequest();
	}
	else{
		xmlhttp = new ActiveXObject('microsoft.XMLHTTP');
	}
	xmlhttp.onreadystatechange = function(){
		if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
				//document.write(xmlhttp.responseText);
			var obj = JSON.parse(xmlhttp.responseText);

			if (obj != 'Error_data') {
				
				for (var i = 0; i < obj.length; i++){
					if (devId.length == 0){
						devId[0] = obj[0].id;
					}
					var j = 0;
					for (j = 0; j < devId.length; j++){
						if(devId[j] == obj[i].id)
							break;
					}
					if(j == devId.length){
						devId[j] = obj[i].id;
					}
					devNum[i] = obj[i];
					var point = {"lng":devNum[i].Lon,"lat":devNum[i].Lat};
								
					makerPoints.push(point);					
					}
				}
				console.log(makerPoints);
				console.log(devNum);
				console.log(devId);
				// clearTimeout(syncEvent);
				// setTimeout(dynamicLine, 100);	
			}					
		}
	xmlhttp.open("GET","/GPSdata",false);
	xmlhttp.send();
	}

	//在轨迹点上创建图标，并添加点击事件，显示轨迹点信息。points,数组。
	drawLinecallback = function (data){
		console.log(data);
		if(data.status === 0){
		// 	var myIcon = new BMap.Icon("track.ico", new BMap.Size(5, 5), {
		// 	offset: new BMap.Size(5, 5) 
		// });


        for (var i = 0; i < data.points.length; i++) {
        	bPoints.push(data.points[i]);
        	
        	//mark point with baidu api
        	var marker = new BMap.Marker(data.points[i]);
        	map.addOverlay(marker);
        	var number = "number " + devNum[i].id;
			var label = new BMap.Label(number,{offset:new BMap.Size(20,-10)});
			marker.setLabel(label);

          //  map.setCenter(data.points[i]);
        }
		for (var i=0; i < data.points.length; i++)
		{

			for(var j=0; j < devId.length; j++){
				if (devId[j] != devNum[i].id){
					continue;
				}
				//new point 
				multiDispObjNew[j] = data.points[i];
				console.log(multiDispObjOld)
				console.log(multiDispObjNew)
				//draw line
				if (multiDispObjOld[j] != null && Math.abs(multiDispObjOld[j] - multiDispObjNew[j]) < 0.000001){

					var startPoint = new BMap.Point(multiDispObjOld[j].lng, multiDispObjOld[j].lat);
					var endPoint = new BMap.Point(multiDispObjNew[j].lng, multiDispObjNew[j].lat);
					var polyline = new BMap.Polyline([startPoint, endPoint], {strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5});
					console.log("sddddddddd");
					map.addOverlay(polyline); 
					//delete old point
					deletePoint(multiDispObjOld[j]);
					
				}
				multiDispObjOld[j] = multiDispObjNew[j];				
			}


		}
		
		while (makerPoints.length > 0){
			makerPoints.pop();
		}
		//syncEvent = setTimeout(loadData, 1000);
			
		map.setCenter(data.points[0]);
		setZoom(bPoints);
		}

	}    

    function deletePoint(locate){
		var allOverlay = map.getOverlays();

		for(var i = 0; i < allOverlay.length - 1; i++){
				// console.log(allOverlay[i].point);
			if (allOverlay[i].point != undefined  || allOverlay[i].point != null ){

				if ((Math.abs(allOverlay[i].point.lng - locate.lng) < 0.00000001) &&
				 (Math.abs(allOverlay[i].point.lat - locate.lat) < 0.00000001)){
				console.log(allOverlay[i].point);
				console.log(locate);
				map.removeOverlay(allOverlay[i]);
				//return false;
			}

			}

		}
    }
	function dynamicLine(){

		loadData();

		if (makerPoints.length > 0){
			var convertor = new BMap.Convertor();			
			convertor.translate(makerPoints, 1, 5, drawLinecallback);
			// var point = {"lng":longitude,"lat":lantitude};
		}

		setTimeout(dynamicLine, 1000);
	}

	//根据点信息实时更新地图显示范围，让轨迹完整显示。设置新的中心点和显示级别. 
	//更新。设置不是每次增加点都重新设置显示范围。因为有可能会想放大了看。
	function setZoom(bPoints){
		var view = map.getViewport(eval(bPoints));
		if(map.oldView != JSON.stringify(view)){
			var mapZoom = view.zoom; 
			var centerPoint = view.center; 
			map.centerAndZoom(centerPoint,mapZoom);
			map.oldView = JSON.stringify(view);
		}
	}
	
	//数据准备,
	var bPoints = [];
	var devNum = [];//store receive device gps info
	var devId = [];//store device mac address
	var multiDispObjOld = [];
	var multiDispObjNew = [];
	var makerPoints = []; //marker all point each time
	//地图操作开始
	var map = new BMap.Map("allmap");  //contina not ok

	map.centerAndZoom(new BMap.Point(117.25 ,31.83), 13); //初始显示hefei。
	map.addControl(new BMap.NavigationControl());
	map.enableScrollWheelZoom();//滚轮放大缩小

	//syncEvent = setTimeout(loadData, 1000);//动态生成新的点。
	window.dynamicLine();
</script>  
