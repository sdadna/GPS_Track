<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="http://lbsyun.baidu.com/trace/admin/static/bootstrap/css/bootstrap_b19c5f7.css">
	<link rel="stylesheet" href="http://lbsyun.baidu.com/trace/admin/static/bootstrap/css/bootstrap-datetimepicker.min_2f0baee.css">	
	<link rel="stylesheet" href="http://lbsyun.baidu.com/trace/admin/static/css/common_54dc7fc.css">
    <link rel="stylesheet" type="text/css" href="http://lbsyun.baidu.com/trace/admin/static/css/animate_07f1461.css" />
    <link rel="stylesheet" type="text/css" href="http://lbsyun.baidu.com/trace/admin/static/icheck-1.x/square/blue_4434e78.css" />
    <link rel="stylesheet" type="text/css" href="http://lbsyun.baidu.com/trace/admin/static/css/normalize_9370ef2.css" />
    <style type="text/css">
    	
        html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}

    </style>


    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=49GGbQCNje057FGWVlchcHeNNuAZKgMh"></script>
    <script src="jquery-3.2.1.js"></script>
 	
    <title>trace gps</title>
</head>

<body> 
	<div class="trunk" id="trunk">

		<div id="allmap">

		</div> 

	<div class="manageControl">
    <div class="manageTop">
     <div class="serviceName">
      GPS_Location管理
     </div>
     <div class="toggleOutManage" data-toggle="collapse" data-target="#manageBottom"></div>
    </div>
    <div class="collapse" id="manageBottom" style="height: 0px;">
     <div class="manageBottom">
      <div class="manageTab">
       <div class="monitorTab">
        <!-- react-text: 35 -->实时监控
        <!-- /react-text -->
        <div class="monitorTabIcon"></div>
       </div>
   <!--     <div class="trackTab">
        轨迹查询
        
        <div class="trackTabIcon"></div>
       </div> -->
       <div class="pointerTabLeft"></div>
      </div>
      <div class="monitor visible">
       <div class="monitorSearch">
        <input class="searchInputMonitor" placeholder="请输入手机号" />
        <img src="http://lbsyun.baidu.com/trace/admin/static/images/searchicon_2x_ab6e941.png" class="searchBtnMonitor" />
        <div class="lineMonitor"></div>
        <img src="http://lbsyun.baidu.com/trace/admin/static/images/clearsearch_2x_e373e6e.png" class="clearSearchBtnMonitor hideCommon" />
       </div>
       <div class="monitorList">
        <div class="monitorAll" style="color: rgb(10, 140, 255);"></div>
<!--         <div class="monitorOnline">
        </div> -->
<!--         <div class="monitorOffline">
        </div> -->
        <div class="monitorBottomLineLeft"></div>
       </div>
       <div class="monitorAllContent visible">
        <div class="monitorFrame">
 		
   		</div>
      <!--      <div class="monitorPage">
         <div class="jumpPage">
          <input class="inputPage" type="text" />
          <span class="pageNumber">
          /0页</span>
          <span class="goPage">GO</span>
         </div>
         <div class="switchPage">
          <span class="lastPageOff"></span>
          <span class="nextPageOff"></span>
         </div>
        </div> -->
  </div>
       </div>
       <div class="monitorOnlineContent hidden">
        <div class="monitorFrame"></div>
        <!-- switch page -->
<!--         <div class="monitorPage">
         <div class="jumpPage">
          <input class="inputPage" type="text" />
          <span class="pageNumber">
           / 0
           页</span>
          <span class="goPage">GO</span>
         </div>
         <div class="switchPage">
          <span class="lastPageOff"></span>
          <span class="nextPageOff"></span>
         </div>
        </div> -->
       </div>
       <div class="monitorOfflineContent hidden">
        <div class="monitorFrame"></div>
        <!-- switch page -->
<!--         <div class="monitorPage">
         <div class="jumpPage">
          <input class="inputPage" type="text" />
          <span class="pageNumber">
           / 0页
          </span>
          <span class="goPage">GO</span>
         </div>
         <div class="switchPage">
          <span class="lastPageOff"></span>
          <span class="nextPageOff"></span>
         </div>
        </div> -->
       </div>
      </div>
      <div class="track hidden">
       <div class="trackDatetime">
        <div class="input-append date" id="datetimepicker" data-date-format="yyyy-mm-dd">
         <input class="datetimeInput" size="16" type="text" />
         <span class="add-on datetimeBtn"><i class="icon-th"></i></span>
        </div>
       </div>
       <div class="trackSearch">
        <input class="searchInputMonitor" placeholder="请输入关键字" />
        <img src="/trace/admin/static/images/searchicon_2x_ab6e941.png" class="searchBtnMonitor" />
        <div class="lineMonitor"></div>
        <img src="/trace/admin/static/images/clearsearch_2x_e373e6e.png" class="clearSearchBtnMonitor hideCommon" />
       </div>
       <div class="trackContent">
        <div class="monitorFrame">
         <div class="monitorListItem">
          <div class="monitorListItemName"></div>
          <div class="monitorListItemSpeed"></div>
         </div>
         <div class="monitorListItem">
          <div class="monitorListItemName"></div>
          <div class="monitorListItemSpeed"></div>
         </div>
         <div class="monitorListItem">
          <div class="monitorListItemName"></div>
          <div class="monitorListItemSpeed"></div>
         </div>
         <div class="monitorListItem">
          <div class="monitorListItemName"></div>
          <div class="monitorListItemSpeed"></div>
         </div>
         <div class="monitorListItem">
          <div class="monitorListItemName"></div>
          <div class="monitorListItemSpeed"></div>
         </div>
         <div class="monitorListItem">
          <div class="monitorListItemName"></div>
          <div class="monitorListItemSpeed"></div>
         </div>
         <div class="monitorListItem">
          <div class="monitorListItemName"></div>
          <div class="monitorListItemSpeed"></div>
         </div>
         <div class="monitorListItem">
          <div class="monitorListItemName"></div>
          <div class="monitorListItemSpeed"></div>
         </div>
         <div class="monitorListItem">
          <div class="monitorListItemName"></div>
          <div class="monitorListItemSpeed"></div>
         </div>
         <div class="monitorListItem">
          <div class="monitorListItemName"></div>
          <div class="monitorListItemSpeed"></div>
         </div>
        </div>]
        <!-- switch page -->
<!--         <div class="monitorPage">
         <div class="jumpPage">
          <input class="inputPage" type="text" />
          <span class="pageNumber">
           / 0页</span>
          <span class="goPage">GO</span>
         </div>
         <div class="switchPage">
          <span class="lastPageOff"></span>
          <span class="nextPageOff"></span>
         </div>
        </div> -->
       </div>
      </div>
     </div>
    </div>
   </div>

   
	</div>

<script type="text/javascript" src="http://lbsyun.baidu.com/trace/admin/static/bootstrap/js/bootstrap.min_bed31fb.js"></script>
<script type="text/javascript" src="http://lbsyun.baidu.com/trace/admin/static/bootstrap/js/bootstrap-datetimepicker.min_eadaff3.js"></script>


<script type="text/javascript"  charset="UTF-8" src="http://lbsyun.baidu.com/trace/admin/static/bootstrap/js/bootstrap-datetimepicker.zh-CN_1c1e718.js"></script>
<!-- <script src="https://cdn.bootcss.com/echarts/3.6.2/echarts.min.js"></script>   
 -->

<!-- react  -->
 <script src="https://cdn.bootcss.com/react/15.4.2/react.min.js"></script>
<script src="https://cdn.bootcss.com/react/15.4.2/react-dom.min.js"></script>
<script src="https://cdn.bootcss.com/babel-standalone/6.22.1/babel.min.js"></script>

</body>  
</html>

<script > 
	// 实时轨迹demo。
	// 实际运用的话可能ajax实时读取后台数据，加载到地图上。

	function devClick(info){
		console.log(info);
		var js=$(info).html();
		var deviceID = js.split('title="')[1].split('"')[0];
		var i = 0;

		//find the item which clicked
		for(i=0; i < devId.length; i++){
			if(deviceID == devId[i]){
				console.log(i);
				break;
			}
		}

		if(i < devId.length){
			//mark the item
			//var newBPoint =new BMap.Point(117.02, 32.05);
			var marker = new BMap.Marker(multiDispObjNew[i]);
			addMarker(date[i],devId[i],marker);

			map.centerAndZoom(multiDispObjNew[i], 19);

	  //   	var number = "number " + devId[i];
			// var label = new BMap.Label(number,{offset:new BMap.Size(20,-10)});
			// //var p = marker.getPosition();
			// marker.setLabel(label);
			// //marker.disableMassClear();	
			// map.addOverlay(marker);
		}
		console.log(i);
		console.log(date[i]);
		console.log(devId[i]);

	}
	//show all device info
	function devList(){

		var searchDev = arguments[0] ? arguments[0]:false;
		var searchDevID = arguments[1] ? arguments[1]:0;

		//search device false then show all device
		if (searchDev == false){
			var devFrame="";
			for(var i=0; i < devId.length; i++){
				devFrame += "<div onclick='devClick(this)' class='monitorListItem2' data-entity_name='" + devId[i] + "' data-entity_desc='无' data-entity_status='2' data-entity_id='"+ devId[i] +"'>"
				devFrame += "<div class='monitorListItemName'><abbr title='" + devId[i] + "'>" + devId[i] + " </abbr></div></div>";
				//device status
				// devFrame += "<div class='monitorListItemSpeed'>Offline</div></div>";
				
			}
			$(".monitorFrame").html(devFrame);
			var deviceNum = "All (" + devId.length + ")";
			$(".monitorList").children('div.monitorAll').text(deviceNum);
		}else{
			//search true then show the device searched
			var devFrame="";

			for(var i=0; i < devId.length; i++){
				if(devId[i] == searchDevID){
					devFrame += "<div onclick='devClick(this)' class='monitorListItem2' data-entity_name='" + devId[i] + "' data-entity_desc='无' data-entity_status='2' data-entity_id='"+ devId[i] +"'>"
					devFrame += "<div class='monitorListItemName'><abbr title='" + devId[i] + "'>" + devId[i] + " </abbr></div>";
					break;
				}
			}
			//show device name		
			$(".monitorFrame").html(devFrame);
			//show device number searched
			if(devFrame.length > 0){
				var deviceNum = "All (" + "1" + ")";			
			}
			else{
				var deviceNum = "All (" + "0" + ")";
			}
			$(".monitorList").children('div.monitorAll').text(deviceNum);

		}
		
			// $(".monitorList").children('div.monitorOnline').text("Online(0)");
			// $(".monitorList").children('div.monitorOffline').text("Offline(0)");

	}

	function loadData(){
		$.get('GPSdata', function(data, status){

			if(status == 'success'){
				var obj = JSON.parse(data);

				if (obj != 'Error_data') {
					//store all device number to devId and store temp device info to devNum
					for (var i = 0; i < obj.length; i++){
						if (devId.length == 0){
							devId[0] = obj[0].id;
							date[0] = obj[0].date;							
						}
						var j = 0;
						for (j = 0; j < devId.length; j++){
							if(devId[j] == obj[i].id)
								break;
						}
						if(j == devId.length){
							devId[j] = obj[i].id;
							//date[j] = obj[i].date;
						}
						devNum[i] = obj[i];
						date[j] = obj[i].date;
						var point = {"lng":devNum[i].Lon,"lat":devNum[i].Lat};
									
						makerPoints.push(point);					
						}
						console.log(makerPoints);
						console.log(devNum);
						console.log(devId);
					}	
			}
		});
	}
	//show window info 
	function openInfo(content,e){
		var p = e.target;
		var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
		var opts = {
		width : 0,
		 //info window width, 0 auto adjust,220-730
		height: 0,
		 // 信息窗口高度 0 auto adjust 60-650
		title : "DetailInfo" // 信息窗口标题
		}
		var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象 
		map.openInfoWindow(infoWindow,point); //开启信息窗口
	}

	//draw line
	drawAllLinecallback = function(GPSPoints){
		console.log(GPSPoints);
		if(GPSPoints.status === 0){
			for(var i=1; i<GPSPoints.points.length; i++){
				var startPoint = new BMap.Point(GPSPoints.points[i-1].lng, GPSPoints.points[i-1].lat);
				var endPoint = new BMap.Point(GPSPoints.points[i].lng, GPSPoints.points[i].lat);
				var polyline = new BMap.Polyline([startPoint, endPoint], {strokeColor:"blue", strokeWeight:5, strokeOpacity:0.5});					

				map.addOverlay(polyline); 					
			}
		}
	
	}
	//connect each line
	connectLine = function(GPSPoints){
		if(GPSPoints.status === 0){
			for(var i=1; i<GPSPoints.points.length; i++){
				var startPoint = new BMap.Point(GPSPoints.points[i-1].lng, GPSPoints.points[i-1].lat);
				var endPoint = new BMap.Point(GPSPoints.points[i].lng, GPSPoints.points[i].lat);
				var polyline = new BMap.Polyline([startPoint, endPoint], {strokeColor:"blue", strokeWeight:5, strokeOpacity:0.5});					

				map.addOverlay(polyline); 					
			}
		}
	}

	function drawLine(data, tmpDev){
		console.log(data);
		console.log(tmpDev);
		var i = 0;
		for(i=0; i<devId.length; i++){
			console.log(devId[i]);
			if(data[devId[i]].id == tmpDev)
				break;
		}
		if (i == devId.length){
			return;
		}		
		var dev = data[devId[i]].id;
		var devPoint = data[devId[i]].points;
		console.log(dev);
		console.log(devPoint);
		//more than 10 point
		console.log(devPoint.length);
		if (devPoint.length > 20){
			var numCir = Math.floor(devPoint.length / 20);
			var remainPoint = devPoint.length % 20;
			var convertor = new BMap.Convertor();
							console.log(numCir);
				console.log(remainPoint);
			for (var i=1; i < (numCir + 1); i++){
				var devPoints = [];
				var connectLinePoint = [];

				for (var j = (i-1)*10; j < i * 10; j++){
					var point = {"lng":devPoint[2*j+1],"lat":devPoint[2*j]};
					devPoints.push(point);
					if(j == i * 10 - 1){
						connectLinePoint.push(point);
						connectLinePoint.push({"lng":devPoint[2*(j+1)+1],"lat":devPoint[2*(j+1)]});
					}
				}
				//draw 10 point to one line
				convertor.translate(devPoints, 1, 5, drawAllLinecallback);
				//draw connect line
				convertor.translate(connectLinePoint, 1, 5, drawAllLinecallback);
			}
			//could not fill 10 point set do follow steps
			if (remainPoint > 0){
				var devPoints = [];
				for(var i = 0; i < (remainPoint / 2); i++){
					var point = {"lng":devPoint[numCir * 20 + 2*i+1],"lat":devPoint[numCir * 20 + 2*i]};
					devPoints.push(point);
				}
				console.log(devPoints);
				convertor.translate(devPoints, 1, 5, drawAllLinecallback);
			}


		}else{
			//less than 10 point
			var devPoints = [];
			var convertor = new BMap.Convertor();
			for (var i = 0; i < (devPoint.length / 2); i++){
				var point = {"lng":devPoint[2*i+1],"lat":devPoint[2*i]};
				devPoints.push(point);
			}
			
			convertor.translate(devPoints, 1, 5, drawAllLinecallback);
		}

	}

	function addMarker(date, devId, marker){
		map.addOverlay(marker);

    	var number = "number " + devId;
		var label = new BMap.Label(number,{offset:new BMap.Size(20,-10)});
		//var p = marker.getPosition();
		marker.setLabel(label);
		marker.disableMassClear();				
		//marker.setAnimation(BMAP_ANIMATION_BOUNCE);
			//alert(pointPosition.lng + "," + pointPosition.lat);

		var myGeo = new BMap.Geocoder();
		// 根据坐标得到地址描述

		marker.addEventListener("click", function(e){
			var pt = e.point;
			console.log(pt);
			myGeo.getLocation(pt, function(result){
				var addComp = result.addressComponents;
				var content = "ID:" + devId + "<br>";
				content += "location:" + addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber + "<br>";
				content += "position:" + pt.lng + "," + pt.lat + "<br>";
				content += "date:" + date + "<br>";
				//output the point info
				openInfo(content, e);
			});

		});
		marker.addEventListener("rightclick", function(result){
			console.log(result);
			$.get("drawLine", function(data, status){
				if (status == "success"){
					var obj = JSON.parse(data);
					drawLine(obj, devId);

				}
				
			});			
		});

	}

	

    function deletePoint(locate){
		var allOverlay = map.getOverlays();

		for(var i = 0; i < allOverlay.length - 1; i++){
				// console.log(allOverlay[i].point);
			if (allOverlay[i].point != undefined  || allOverlay[i].point != null ){

				if ((Math.abs(allOverlay[i].point.lng - locate.lng) < 0.00000001) &&
				 (Math.abs(allOverlay[i].point.lat - locate.lat) < 0.00000001)){
				console.log(allOverlay[i].point);
				console.log(locate);
				map.removeOverlay(allOverlay[i]);
				//return false;
			}

			}

		}
    }

    //在轨迹点上创建图标，并添加点击事件，显示轨迹点信息。points,数组。
	drawLinecallback = function (data){
		console.log(data);
		if(data.status === 0){
		// 	var myIcon = new BMap.Icon("track.ico", new BMap.Size(5, 5), {
		// 	offset: new BMap.Size(5, 5) 
		// });


   //      for (var i = 0; i < data.points.length; i++) {
   //      	bPoints.push(data.points[i]);
        	
   //      	//mark point with baidu api
   //      	var marker = new BMap.Marker(data.points[i]);
   //      	map.addOverlay(marker);

   //      	var number = "number " + devNum[i].id;
			// var label = new BMap.Label(number,{offset:new BMap.Size(20,-10)});
			// marker.setLabel(label);

   //        //  map.setCenter(data.points[i]);
   //      }
		for (var i=0; i < data.points.length; i++)
		{
			// update all device marker
			for(var j=0; j < devId.length; j++){
				if (devId[j] != devNum[i].id){
					continue;
				}

				bPoints.push(data.points[i]);
	        	
	        	//mark point with baidu api
	        	var marker = new BMap.Marker(data.points[i]);
	        	
	        	addMarker(devNum[i].date, devId[j], marker);
				//new point 
				multiDispObjNew[j] = data.points[i];

				// console.log(multiDispObjOld);
				// console.log(multiDispObjNew);
				// //draw line
				if (multiDispObjOld[j] != null && ((Math.abs(multiDispObjOld[j].lng - multiDispObjNew[j].lng) > 0.000001) || Math.abs(multiDispObjOld[j].lat - multiDispObjNew[j].lat) > 0.000001 )){
				//if (multiDispObjOld[j] != null)	{
					// var startPoint = new BMap.Point(multiDispObjOld[j].lng, multiDispObjOld[j].lat);
					// var endPoint = new BMap.Point(multiDispObjNew[j].lng, multiDispObjNew[j].lat);
					// var polyline = new BMap.Polyline([startPoint, endPoint], {strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5});					

					// map.addOverlay(polyline); 
					//delete old point
					deletePoint(multiDispObjOld[j]);					
				}
				multiDispObjOld[j] = multiDispObjNew[j];	
							
			}


		}

		devList();
		while (makerPoints.length > 0){
			makerPoints.pop();
		}
		//syncEvent = setTimeout(loadData, 1000);
			
		map.setCenter(data.points[0]);
		setZoom(bPoints);
		}

	}    

	function dynamicLine(){

		loadData();

		if (makerPoints.length > 0){
			var convertor = new BMap.Convertor();			
			convertor.translate(makerPoints, 1, 5, drawLinecallback);
			// var point = {"lng":longitude,"lat":lantitude};
		}

		setTimeout(dynamicLine, 1000);
	}

	//根据点信息实时更新地图显示范围，让轨迹完整显示。设置新的中心点和显示级别. 
	//更新。设置不是每次增加点都重新设置显示范围。因为有可能会想放大了看。
	function setZoom(bPoints){
		var view = map.getViewport(eval(bPoints));
		if(map.oldView != JSON.stringify(view)){
			var mapZoom = view.zoom; 
			var centerPoint = view.center; 
			map.centerAndZoom(centerPoint,mapZoom);
			map.oldView = JSON.stringify(view);
		}
	}
	
	//数据准备,
	var bPoints = [];
	var devNum = [];//store receive device gps info
	var devId = [];//store device mac address
	var date = [];//store device time info
	var multiDispObjOld = [];
	var multiDispObjNew = [];
	var makerPoints = []; //marker all point each time
	//地图操作开始
	var map = new BMap.Map("allmap");  //contina not ok

	map.centerAndZoom(new BMap.Point(117.25 ,31.83), 13); //初始显示hefei。
	var opts = {anchor:BMAP_ANCHOR_TOP_RIGHT};
	map.addControl(new BMap.NavigationControl(opts));
	var opts1 = {offset:new BMap.Size(150, 5)};
	map.addControl(new BMap.ScaleControl(opts1));
	map.enableScrollWheelZoom();//滚轮放大缩小

	//delete all marker on map 
	map.addEventListener('rightclick',function(result){
		var overlays = map.getOverlays();
		//console.log(overlays);
		map.clearOverlays();
	});

	$(document).ready(function(){
	 		//syncEvent = setTimeout(loadData, 1000);//动态生成新的点。
		window.dynamicLine();
		
	 });

	//
	$(".toggleOutManage").click(function(t) {
	  	var n = e(this),
	    r, i = n.attr("data-target") || t.preventDefault() || (r = n.attr("href")) && r.replace(/.*(?=#[^\s]+$)/, ""),
	    s = e(i).data("collapse") ? "toggle" : n.data();
	  n[e(i).hasClass("in") ? "addClass" : "removeClass"]("collapsed"), e(i).collapse(s)
	});

	$(".searchBtnMonitor").click(function(t){
		var deviceID = $("input[class='searchInputMonitor']").val();
		console.log(deviceID);
		devList(true, deviceID);
	});
	$(".clearSearchBtnMonitor").click(function(t){
		
		console.log(t);
		//hide clearSearchBtnMonitor
		var clearClassName=document.getElementsByClassName("clearSearchBtnMonitor");
		//$(".clearSearchBtnMonitor").show();
		console.log(clearClassName);
		clearClassName[0].className = "clearSearchBtnMonitor hideCommon";
		var inputClassName=document.getElementsByClassName("searchInputMonitor");
		//$(".clearSearchBtnMonitor").show();
		console.log(inputClassName);
		inputClassName[0].value = "";

		devList();
	});
	$("input[class='searchInputMonitor']").change(function(){
		//$('#result').html($(this).val().length + ' characters'); 
		var clearClassName=document.getElementsByClassName("clearSearchBtnMonitor");
		//$(".clearSearchBtnMonitor").show();
		console.log(clearClassName);

		clearClassName[0].className = "clearSearchBtnMonitor";
	});

</script>  
